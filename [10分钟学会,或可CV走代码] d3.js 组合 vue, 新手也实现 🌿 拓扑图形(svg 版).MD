# [10åˆ†é’Ÿå­¦ä¼š,æˆ–å¯CVèµ°ä»£ç ] d3.js ç»„åˆ vue, æ–°æ‰‹ä¹Ÿå®ç° ğŸŒ¿ æ‹“æ‰‘å›¾å½¢(svg ç‰ˆ)

## ç›®æ ‡æ•ˆæœ
![](https://user-gold-cdn.xitu.io/2020/5/18/17225b4eb12da619?w=640&h=452&f=gif&s=216643)

[åœ¨çº¿å®ä¾‹](https://any86.github.io/any-touch/#/topology)

## æºç åœ°å€
å¦‚æœæ€¥ç”¨, å¯å…ˆcvèµ°ä»£ç ä¿®æ”¹, å“ªé‡Œæ²¡æ˜ç™½å†å›æ¥çœ‹å“ªé‡Œ.
https://github.com/any86/any-touch/blob/develop/example/src/views/Topology.vue


## ä»‹ç»ä¸‹ D3.js

d3 æ˜¯ä¸€ä¸ªå¤§è€Œå…¨çš„å›¾å½¢åº“, é›†æˆäº†**svg å…ƒç´ æ“ä½œ**å’Œå¸¸è§å›¾è¡¨(å›¾å½¢)çš„**æ•°æ®ç»“æ„**.

æœ¬æ–‡åŸºäº**v5 ç‰ˆæœ¬**çš„ d3 ç¼–å†™, d3 çš„åŠŸèƒ½éƒ½æ˜¯æ‹†åˆ†æˆç‹¬ç«‹åŒ…çš„, æˆ‘ä»¬è¿™é‡Œåªéœ€è¦å¼•å…¥[d3-hierarch](https://github.com/d3/d3-hierarchy)å’Œ[d3-shape](https://github.com/d3/d3-shape)ç”Ÿæˆæ‹“æ‰‘çš„æ•°æ®ç»“æ„.
```javascript
// hierarchy ç”¨æ¥ç”Ÿæˆd3çš„æ ‘å½¢å¯¹è±¡, åŒæ—¶æŒ‚è½½ä¸€äº›æ–¹æ³•, æ¯”å¦‚è·å–å­å…ƒç´ descendants
// tree ç”¨æ¥ç»™èŠ‚ç‚¹åˆ†é…x/yåæ ‡
// linkHorizontalç”¨æ¥ç”Ÿæˆæ°´å¹³è¿æ¥çº¿
import {hierarchy, tree} from 'd3-hierarchy';
import {linkHorizontal} from 'd3-shape';
```

## ä»£ç æ¶æ„

1. ä½¿ç”¨ [d3](https://github.com/d3/d3) ç”Ÿæˆæ‹“æ‰‘æ•°æ®ç»“æ„(å…¶å®å°±æ˜¯æ ‘å½¢, æ¯ä¸ªèŠ‚ç‚¹ä¼šç”Ÿæˆ x/y åæ ‡).
2. ä½¿ç”¨ [vue](https://github.com/vuejs/vue) è¿›è¡Œ svg çš„ dom ç»“æ„æ¸²æŸ“(ä¹Ÿå¯ç”¨ canvas è¿›è¡Œæ¸²æŸ“).
3. ä½¿ç”¨ [any-touch](https://github.com/any86/any-touch) æ·»åŠ "**æ‹–æ‹½**"å’Œ"**ç‚¹å‡»å…³é—­/å±•å¼€å­èŠ‚ç‚¹**"åŠŸèƒ½.
4. ç®€å•å°è£…ä¸€ä¸ªåŠ¨ç”»å‡½æ•°, å®ç°å…³é—­/å±•å¼€åŠ¨ç”», çœŸçš„å¾ˆç®€å•, ä»…ä»…ä¸ºäº†é”¦ä¸Šæ·»èŠ±, å¦‚æœä¸éœ€è¦åŠ¨ç”»æ­¤å¤„å†…å®¹å¯ä»¥è·³è¿‡.

## ä»£ç è§£è¯»ğŸ‘¨â€ğŸ«
ä¸‹é¢ä»£ç çœ‹èµ·æ¥é•¿, ä½†æ˜¯ä¸»è¦éƒ½æ˜¯æ³¨é‡Š.
### d3 ç”Ÿæˆæ‹“æ‰‘æ•°æ®ç»“æ„

```javascript
// æµ‹è¯•æ•°æ®
// æ™®é€šæ ‘å½¢
const dataset = {
    name: 'ç¬¬1çº§',
    children: [
        {
            name: 'ç¬¬2çº§',
            children: [
                {
                    name: 'ç¬¬3çº§A',
                    children: [
                        {
                            name: 'ç¬¬4çº§A',
                        },
                        {
                            name: 'ç¬¬4çº§B',
                        },
                    ],
                },
            ],
        },
    ],
};
```

ä¸‹é¢ä»£ç çœ‹èµ·æ¥å¾ˆé•¿, ä½†å®é™…åªæœ‰**4ä¸ªæ–¹æ³•æ€»20å‡ è¡Œ**ä»£ç ,å‰©ä½™éƒ½æ˜¯**æ³¨é‡Š**.

```javascript
{
    /**
     * æŠŠæ™®é€šæ ‘å½¢å˜æˆd3éœ€è¦çš„æ ‘å½¢
     */
    genTreeData(data) {
        const width = 1000;
        const height = 1000;
        // hierarchyæŠŠæ™®é€šçš„æ ‘å½¢æ•°æ®å˜æˆd3çš„treeç»“æ„,
        // è¿™æ ·treeå°±æœ‰äº†d3çš„æ–¹æ³•, å¯ä»¥é€šè¿‡æ–¹æ³•è·å–å­èŠ‚ç‚¹(tree.descendants)/çˆ¶èŠ‚ç‚¹/èŠ‚ç‚¹æ•°ç­‰ä¿¡æ¯
        const root = hierarchy(data);
        // éå†å­èŠ‚ç‚¹,descendantsæ˜¯åä»£çš„æ„æ€,
        // ä½†æ˜¯å…¶å®ä¹Ÿä¼šåŒ…å«å½“å‰èŠ‚ç‚¹æœ¬èº«.
        // ç»™èŠ‚ç‚¹å¢åŠ hiddenå­—æ®µç”¨æ¥æ§åˆ¶å½“å‰èŠ‚ç‚¹æ˜¾ç¤º/éšè—.
        root.descendants().forEach((node) => {
            node.hidden = false;
        });
        // d3.treeè¿è¡Œåä¼šè¿”å›ä¸€ä¸ªå‡½æ•°,
        // é€šè¿‡å‡½æ•°å¯ä»¥è®¾ç½®å›¾å½¢çš„ä¸€äº›å°ºå¯¸(nodeSize)/ä½ç½®é—´è·(separation)ä¿¡æ¯
        // è¿™æ ·åœ¨è¿”å›çš„å‡½æ•°ä¸­ä¼ å…¥åˆšæ‰è¾“å…¥çš„d3.treeç»“æ„æ•°æ®, æ¯”å¦‚ä¸Šé¢çš„root,
        // é‚£ä¹ˆæ‹“æ‰‘æ‰€éœ€çš„æ•°æ®å°±éƒ½å…¨äº†.
        return (
            tree()
                .separation(function(a, b) {
                    // åŒçº§å…ƒç´ è°ƒæ•´é—´éš™æ¯”ä¾‹
                    // ä¸€èˆ¬å°±ç”¨2:1å°±å¥½
                    return (a.parent == b.parent ? 2 : 1) / a.depth;
                })
                // èŠ‚ç‚¹å°ºå¯¸
                .nodeSize([110, width / (root.height + 1)])(root)
        );
    },

    /**
     * ç”ŸæˆèŠ‚ç‚¹æ•°ç»„ => [Node, Node]
     * ç”¨æ¥ç»™æ¨¡æ¿æ¸²æŸ“å…ƒç´ 
     */
    updateNodes() {
        this.nodes = this.tree.descendants();
    },

    /**
     * ç”Ÿæˆçº¿
     */
    updateLinks() {
        // tree.linksä¼šæ ¹æ®èŠ‚ç‚¹æ•°æ®ç”Ÿæˆè¿çº¿æ•°æ®
        this.linkPaths = this.tree.links().map((link) => {
            // d.linkHorizontalå’Œä¸Šé¢çš„d3.treeä¸€æ ·,
            // å¯ä»¥å½“åšæ„é€ å‡½æ•°,
            // å…¶è¿”å›ä¸€ä¸ªå‡½æ•°
            // å¯ä»¥ç”¨å‡½æ•°ä¸Šçš„x/yæ–¹æ³•æŒ‡å®š
            // ç”±äºé»˜è®¤ç”Ÿæˆtreeæ•°æ®æ˜¯ä¸Šä¸‹ç»“æ„çš„æ‹“æ‰‘æ•°æ®,
            // æ‰€ä»¥ä¸ºäº†ç”Ÿæˆå·¦è‡³å³çš„çº¿éœ€è¦æŠŠX/Yæ•°æ®é¢ å€’
            // æœ€ç»ˆç”Ÿæˆçº¿æ•°æ®ç»“æ„ç±»ä¼¼è¿™æ ·:{source:{},target:{}}
            if (!link.target.hidden) {
                return linkHorizontal()
                    .x((d) => d.y)
                    .y((d) => d.x)(link);
            }
        });
    },
    /**
     * ç”Ÿæˆæ‰€éœ€æ•°æ®
     */
    renderTree() {
        this.tree = this.genTreeData(dataset);
        this.updateLinks();
        this.updateNodes();
    },
}
```

### ä½¿ç”¨ vue ç”Ÿæˆ svg çš„ dom ç»“æ„

dom ç»“æ„çœ‹èµ·æ¥å¤ªé•¿äº†, ä½†å®é™…åªåšäº† 2 ä»¶äº‹:

1. å¾ªç¯ç”ŸæˆèŠ‚ç‚¹, ç”¨`<foreignObject>`å…ƒç´ å®ç° svg å†…éƒ¨å¯ä»¥åµŒå¥—æ™®é€š html å…ƒç´ .
2. å¾ªç¯ç”ŸæˆèŠ‚ç‚¹é—´çš„è¿çº¿.

```html
<svg xmlns="http://www.w3.org/2000/svg" width="1000" height="1000" style="width:100%">
    <g transform="translate(100, 100)">
        <template v-for="(linkPath, index) in linkPaths">
            <path v-if="linkPath" :key="index" :d="linkPath" class="line" />
        </template>
    </g>

    <g transform="translate(100, 100)">
        <foreignObject
            v-for="(node,index) in nodes"
            v-show="!node.hidden"
            :class="{[`at-${action}`]:activeNode===node}"
            :key="'foreignObject'+index"
            :width="itemWidth"
            :height="itemHeight"
            :x="node.y - itemWidth/2"
            :y="node.x - itemHeight/2"
            @panstart="onPanstart(index,$event)"
            @panmove="onPanmove(index,$event)"
            @panend="onPanend"
            @pancancel="onPanend"
            @tap="onTap(index)"
        >
            <body xmlns="http://www.w3.org/1999/xhtml">
                <div class="text">
                    <p>èŠ‚ç‚¹å±‚çº§: {{node.depth}}</p>
                    <p>èŠ‚ç‚¹é¡ºåº: {{index}}</p>
                </div>
            </body>
        </foreignObject>
    </g>
</svg>
```

### ä½¿ç”¨any-touchå¢åŠ æ‹–æ‹½å’Œç‚¹å‡»åŠŸèƒ½

```javascript
{
    /**
     * æ‹–æ‹½å¼€å§‹, è®°å½•å½“å‰èŠ‚ç‚¹
     */
    onPanstart(index, e) {
        const [item] = this.nodes.splice(index, 1);
        this.nodes.push(item);
        this.activeNode = item;
    },

    /**
     * æ‹–æ‹½ä¸­
     * å˜åŒ–èŠ‚ç‚¹åæ ‡
     * é‡æ–°ç”Ÿæˆè¿çº¿æ•°æ®
     */
    onPanmove(index, e) {
        this.action = e.type;
        const { deltaX, deltaY } = e;
        const { length } = this.nodes;
        this.activeNode.x += deltaY;
        this.activeNode.y += deltaX;
        this.updateLinks();
    },

    /**
     * å–æ¶ˆå½“å‰èŠ‚ç‚¹æ¿€æ´»
     */
    onPanend() {
        this.activeNode = null;
    },

    /**
     * æ”¶èµ·/å±•å¼€å­èŠ‚ç‚¹
     */
    onTap(index) {
            this.activeNode = this.nodes[index];
            // å½“å‰èŠ‚ç‚¹è®°å½•æ˜¯å¦æ”¶èµ·/å±•å¼€
            if (void 0 === this.activeNode.collapse) {
                this.$set(this.activeNode, 'collapse', true);
            } else {
                this.activeNode.collapse = !this.activeNode.collapse;
            }
            const { x, y, collapse } = this.activeNode;
            // descendantsè¿”å›çš„å­èŠ‚ç‚¹åŒ…å«è‡ªå·±, æ‰€ä»¥æ’é™¤è‡ªå·±
            const [a, ...childNodes] = this.activeNode.descendants();
            // æ ¹æ®èŠ‚ç‚¹æŠ˜å çŠ¶æ€æ¥å±•å¼€/æŠ˜å å­èŠ‚ç‚¹æ˜¾ç¤º
            childNodes.forEach((node) => {
                if (collapse) {
                    const x1 = node.x;
                    const y1 = node.y;
                    // å­˜å‚¨å±•å¼€æ—¶å€™çš„ä½ç½®,
                    // ä¸‹æ¬¡å¤åŸä½ç½®ç”¨
                    node._x = x1;
                    node._y = y1;
                    animate(1, 0, 200, (value, isDone) => {
                        node.x = x - (x - x1) * value;
                        node.y = y - (y - y1) * value;
                        if (isDone) {
                            node.hidden = true;
                        }
                        this.updateLinks();
                    });
                } else {
                    node.hidden = false;
                    // æ­¤å¤„è®©valueä»0 - 1åœ¨200mså†…ä¸åœå˜åŒ–
                    // ä»è€Œè®©èŠ‚ç‚¹ä½ç½®å˜åŒ–å®ç°å±•å¼€æ”¶ç¼©åŠ¨ç”»
                    animate(0, 1, 200, (value) => {
                        node.x = x + (node._x - x) * value;
                        node.y = y + (node._y - y) * value;
                        this.updateLinks();
                    });
                }
            });
    }
}
```

### åŠ¨ç”»(animateå‡½æ•°)
æºç : https://github.com/any86/any-touch/blob/develop/example/src/views/topology.js#L35
animateå‡½æ•°å®ç°å…¶å®å¾ˆç®€å•, ä¸»è¦è¯´ä¸‹`easeInOut`å‡½æ•°, ä»–å…¶å®å°±æ˜¯ä¸€ä¸ª"æ—¶é—´ä¸ºxè½´, å€¼ä¸ºyè½´çš„æ›²çº¿", æ˜¯æˆ‘ç™¾åº¦æœçš„, å…¶å®è¿˜æœ‰å¾ˆå¤šç±»ä¼¼çš„æ›²çº¿å‡½æ•°, å¤§å®¶å¯è‡ªè¡Œæœç´¢. å¤§å®¶å¯ä»¥è‡ªå·±å°è¯•å†™ä¸€ä¸ª, æ¯”å¦‚å€ŸåŠ©`Math.sin`. 

åŠ¨ç”»åœ¨æœ¬ä¾‹å°±æ˜¯é”¦ä¸Šæ·»èŠ±, é€»è¾‘ä¹Ÿå¾ˆç®€å•ä¸å±•å¼€è®²è§£, å¦‚æœæœ‰å…´è¶£å¯ç•™è¨€è®¨è®º.
```javascript
/**
 * t æ—¶é—´
 * b èµ·å§‹å€¼
 * c ç›®æ ‡å€¼
 * d æ‰€éœ€æ—¶é—´
* */
function easeInOut(t, b, c, d) {
    if ((t /= d / 2) < 1) return c / 2 * t * t + b;
    return -c / 2 * ((--t) * (t - 2) - 1) + b;
}

/**
 * ç”¨requestAnimationFrameä¸æ–­æ‰§è¡ŒeaseInOut
 * */
export function animate(from = 0, to = 0, duration = 1000, callback = () => void 0) {
    const startTime = window.performance.now();
    function run() {
        const timeDiff = window.performance.now() - startTime;
        const value = easeInOut(timeDiff, from, to - from, duration);
        if (timeDiff <= duration) {
            callback(value);
            requestAnimationFrame(run);
        } else {
            // ä¿®æ­£è¶…å‡ºè¾¹ç•Œ
            callback(to, true);
        }
    }
    run();
};
```


## æœªæ¥
è®¡åˆ’å°è£…æˆvueç»„ä»¶å¹¶å¼€æº, ä¸€åˆ‡çœ‹å¤§å®¶åé¦ˆ, å¦‚æœæ”¯æŒè¿™ä¸ªè®¡åˆ’è¯·ä¸‹æ–¹ç•™è¨€â˜ï¸.



## ğŸ”¥typescriptç³»åˆ—è¯¾ç¨‹
åŸºç¡€æ•™ç¨‹ä»è¿™é‡Œå¼€å§‹

[ç¬¬ä¸€è¯¾, ä½“éªŒtypescript](https://juejin.im/post/5d19ad6de51d451063431864)

[ç¬¬äºŒè¯¾, åŸºç¡€ç±»å‹å’Œå…¥é—¨é«˜çº§ç±»å‹](https://juejin.im/post/5d1af3426fb9a07ed4411a9b)

[ç¬¬ä¸‰è¯¾, æ³›å‹](https://juejin.im/post/5d27f160e51d45108223fcf9)

[ç¬¬å››è¯¾, è§£è¯»é«˜çº§ç±»å‹](https://juejin.im/post/5d3fe80fe51d456206115987)

[ç¬¬äº”è¯¾, å‘½åç©ºé—´(namespace)æ˜¯ä»€ä¹ˆ](https://juejin.im/post/5d5d04dfe51d4561af16dd24)

[ç‰¹åˆ«ç¯‡, åœ¨vue3ğŸ”¥æºç ä¸­å­¦ä¼štypescriptğŸ¦• - "is"](https://juejin.im/post/5da6d1aae51d4524ad10d1d8)

[ç¬¬å…­è¯¾, ä»€ä¹ˆæ˜¯å£°æ˜æ–‡ä»¶(declare)? ğŸ¦• - å…¨å±€å£°æ˜ç¯‡](https://juejin.im/post/5dcbc9e2e51d451bcb39f123)

[æ–°æ‰‹å‰ç«¯å­¦ğŸ”¥typescript - å®æˆ˜ç¯‡, å®ç°æµè§ˆå™¨å…¨å±(59è¡Œ)](https://juejin.im/post/5dd33ce3e51d453fbf29e0e5)

## ğŸ”¥å¾€æœŸçƒ­é—¨æ–‡ç« 
[ğŸ”¥å¸¸ç”¨æ­£åˆ™å¤§å…¨2020](https://juejin.im/post/5d245d4151882555300feb77)

[ğŸš†æ–°æ‰‹å‰ç«¯ä¸è¦æ…Œ! ç»™ä½ âœŠ10æ ¹æ•‘å‘½ç¨»è‰ğŸƒ](https://juejin.im/post/5d904712e51d45781e0f5dd0)

[çœŸ.1pxè¾¹æ¡†, ğŸš€ æ”¯æŒä»»æ„æ•°é‡è¾¹å’Œåœ†è§’, 1 ä¸ªä¸‡é‡‘æ²¹çš„æ–¹æ³•](https://juejin.im/post/5d70a030f265da03a715f3fd)

[ğŸš€æ­ç§˜vue/reactç»„ä»¶åº“ä¸­ğŸ¤š5ä¸ª"ä½œè€…ä¸é€ çš„è½®å­"](https://juejin.im/post/5d89cd156fb9a06acb3ee19e)

[vue / reactçš„UIåº“éƒ½åœ¨ç”¨çš„å‡ ä¸ªDOM APIğŸš€](https://juejin.im/post/5d808601f265da03ef7a469b)

## å¾®åš
åˆšç©å¾®åš, å’±ä»¬å¯ä»¥äº’ç›¸å…³æ³¨, å˜¿å˜¿
![weibo.png](https://user-gold-cdn.xitu.io/2019/12/30/16f54bffe31ce14b?w=810&h=1020&f=jpeg&s=84481)

## å¾®ä¿¡ç¾¤
![](https://user-gold-cdn.xitu.io/2020/5/18/172263a76a1a824f?w=1080&h=2201&f=png&s=415783)
